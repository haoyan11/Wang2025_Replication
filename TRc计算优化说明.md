# TRcè®¡ç®—ä¼˜åŒ–è¯´æ˜Ž (v1.3.0)

**ä¼˜åŒ–æ—¥æœŸ**: 2025-12-23
**ç‰ˆæœ¬**: 1.3.0

---

## âœ… ä¼˜åŒ–å®Œæˆæ€»ç»“

å·²å®Œæˆ [02_TRc_calculation.py](02_TRc_calculation.py) çš„æ€§èƒ½å’Œæ•°æ®æ­£ç¡®æ€§å…¨é¢ä¼˜åŒ–ã€‚

---

## ðŸš€ ä¸‰å¤§æ ¸å¿ƒä¼˜åŒ–

### 1. å¾ªçŽ¯é¡ºåºä¼˜åŒ– - æ€§èƒ½æå‡18å€+

#### ä¿®æ”¹å‰ï¼ˆæ…¢ï¼‰
```python
for å— in å—åˆ—è¡¨:  # 18ä¸ªå—
    for å¤© in 365å¤©:
        æ‰“å¼€TRæ–‡ä»¶  # âŒ 18 Ã— 365 = 6,570æ¬¡æ–‡ä»¶æ‰“å¼€ï¼ˆæ¯å¹´ï¼‰
```

#### ä¿®æ”¹åŽï¼ˆå¿«ï¼‰
```python
for å¤© in 365å¤©:
    æ‰“å¼€TRæ–‡ä»¶ä¸€æ¬¡  # âœ… æ¯å¤©åªæ‰“å¼€1æ¬¡ = 365æ¬¡ï¼ˆæ¯å¹´ï¼‰
    for å— in å—åˆ—è¡¨:
        è¯»å–windowæ•°æ®
```

**æ€§èƒ½å½±å“**:
- æ–‡ä»¶æ‰“å¼€æ¬¡æ•°ï¼šä»Ž ~24ä¸‡æ¬¡ â†’ ~1.3ä¸‡æ¬¡ï¼ˆ37å¹´ï¼‰
- **é¢„è®¡è¿è¡Œæ—¶é—´ï¼šä»Ž 6-8å°æ—¶ â†’ 20-30åˆ†é’Ÿ** â­

---

### 2. NODATAä¸€è‡´æ€§ä¿®å¤ - æ•°æ®æ­£ç¡®æ€§

#### é—®é¢˜
```python
# ç¡¬ç¼–ç NODATA = -9999
if tr_value != -9999:  # âŒ ERA5-Landçš„nodataå¯èƒ½æ˜¯nanæˆ–3e38
    ç´¯åŠ 
```

**é£Žé™©**: çœŸå®žnodataè¢«å½“æˆæœ‰æ•ˆå€¼ç´¯åŠ ï¼Œå¯¼è‡´TRcå¼‚å¸¸å·¨å¤§ã€‚

#### ä¿®å¤
```python
# è¯»å–æ …æ ¼çœŸå®žnodata
with rasterio.open(file) as src:
    nodata_tr = src.nodata  # âœ… å¯èƒ½æ˜¯nanã€3e38ç­‰

# æ­£ç¡®åˆ¤æ–­
if nodata_tr is None:
    valid = np.isfinite(tr)
elif np.isnan(nodata_tr):
    valid = np.isfinite(tr)
else:
    valid = (tr != nodata_tr) & np.isfinite(tr)
```

---

### 3. valid_phenoæ£€æŸ¥ - æ•°æ®æ­£ç¡®æ€§

#### é—®é¢˜
```python
TRc[mask] = 0.0  # âŒ åªè¦mask=Trueå°±åˆå§‹åŒ–ä¸º0

# å¦‚æžœæŸåƒå…ƒmask=Trueä½†SOS/POSæ— æ•ˆ
# â†’ æ°¸è¿œä¸ç´¯åŠ  â†’ TRc=0 â†’ è¢«è¯¯è®¤ä¸º"è’¸è…¾ä¸º0"
```

#### ä¿®å¤
```python
# æ£€æŸ¥ç‰©å€™æœ‰æ•ˆæ€§
valid_pheno = (
    mask
    & _is_valid_pheno(sos, nodata_sos)
    & _is_valid_pheno(pos, nodata_pos)
    & (sos > 0) & (pos > 0)
    & (pos >= sos)
    & (sos <= days_in_year) & (pos <= days_in_year)
)

# åªå¯¹æœ‰æ•ˆåƒå…ƒåˆå§‹åŒ–ä¸º0
TRc = np.full((height, width), NODATA_OUT)
TRc[valid_pheno] = 0.0  # âœ… æ— æ•ˆç‰©å€™â†’NODATAï¼Œæœ‰æ•ˆç‰©å€™â†’0
```

---

## ðŸ“Š ä¼˜åŒ–æ•ˆæžœå¯¹æ¯”

| é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æå‡ |
|------|--------|--------|------|
| **è¿è¡Œæ—¶é—´** | 6-8å°æ—¶ | 20-30åˆ†é’Ÿ | **18å€+** â­ |
| **æ–‡ä»¶æ‰“å¼€æ¬¡æ•°** | ~24ä¸‡æ¬¡ | ~1.3ä¸‡æ¬¡ | **å‡å°‘95%** |
| **NODATAå¤„ç†** | âŒ ç¡¬ç¼–ç  | âœ… çœŸå®žå€¼ | **ä¿®å¤æ•°æ®é”™è¯¯é£Žé™©** |
| **ç‰©å€™æ£€æŸ¥** | âŒ æ— æ•ˆâ†’0 | âœ… æ— æ•ˆâ†’NODATA | **ä¿®å¤æ•°æ®æ··æ·†** |
| **å†…å­˜å ç”¨** | ä½Ž | ä½Ž | ä¿æŒä¸å˜ |

---

## ðŸŽ¯ ä¿®æ”¹çš„æ–‡ä»¶

### 1. [02_TRc_calculation.py](02_TRc_calculation.py)

**ä¿®æ”¹ä½ç½®**:
- ç¬¬158-307è¡Œ: `calculate_TRc_block_optimized()` å‡½æ•°ï¼ˆå®Œå…¨é‡å†™ï¼‰
- ç¬¬341è¡Œ: `main()` æµ‹è¯•æ—¥æœŸæ”¹ä¸º `YEAR_START`
- ç¬¬347è¡Œ: `main()` æç¤ºä¿¡æ¯ä¿®æ­£

**è¯¦ç»†å˜æ›´**: è§ [CHANGELOG.md](CHANGELOG.md) â†’ ç‰ˆæœ¬ 1.3.0

---

### 2. [CHANGELOG.md](CHANGELOG.md)

æ–°å¢žç‰ˆæœ¬ 1.3.0ï¼Œè¯¦ç»†è®°å½•æ‰€æœ‰ä¼˜åŒ–å†…å®¹ã€‚

---

## ðŸš€ çŽ°åœ¨å¯ä»¥è¿è¡Œäº†

### è¿è¡Œå‘½ä»¤
```bash
cd D:\claude-project\Wang2025_Replication
python 02_TRc_calculation.py
```

### é¢„æœŸæ—¶é—´
- **ä¼˜åŒ–å‰**: 6-8å°æ—¶
- **ä¼˜åŒ–åŽ**: **20-30åˆ†é’Ÿ** â­

### è¾“å‡ºç»“æžœ
```
Wang2025_Analysis/TRc_annual/
â”œâ”€â”€ TRc_1982.tif
â”œâ”€â”€ TRc_1983.tif
...
â””â”€â”€ TRc_2018.tif  # å…±37ä¸ªæ–‡ä»¶
```

---

## âš™ï¸ å¯é€‰è¿›ä¸€æ­¥ä¼˜åŒ–

### 1. è·³è¿‡å·²å­˜åœ¨çš„æ–‡ä»¶
å¦‚æžœéœ€è¦é‡æ–°è¿è¡Œéƒ¨åˆ†å¹´ä»½ï¼Œå¯åœ¨ `main()` ä¸­æ·»åŠ ï¼š
```python
output_file = OUTPUT_DIR / f"TRc_{year}.tif"
if output_file.exists():
    print(f"  âš  è·³è¿‡å·²å­˜åœ¨: {year}")
    continue
```

### 2. å¹¶è¡Œå¤„ç†ï¼ˆè°¨æ…Žä½¿ç”¨ï¼‰
å¦‚æžœæ˜¯SSDä¸”æƒ³è¿›ä¸€æ­¥æé€Ÿï¼Œå¯å¯ç”¨å¹´åº¦å¹¶è¡Œï¼š
```python
# ä¿®æ”¹ main() ä½¿ç”¨ ProcessPoolExecutor
# å»ºè®® MAX_WORKERS=2-4ï¼ˆè¿‡é«˜å¯èƒ½é€‚å¾—å…¶åï¼‰
```

**æ³¨æ„**: å½“å‰ä¼˜åŒ–å·²è¾¾åˆ°å¾ˆå¥½çš„æ•ˆæžœï¼Œå»ºè®®å…ˆè¿è¡Œæµ‹è¯•ã€‚

---

## ðŸ“ ä¿®æ”¹è®°å½•

**å®Œæ•´ä¿®æ”¹è®°å½•**: [CHANGELOG.md](CHANGELOG.md) â†’ ç‰ˆæœ¬ 1.3.0

**ä¸»è¦å˜æ›´**:
1. âœ… å¾ªçŽ¯é¡ºåºï¼šå…ˆå—åŽå¤© â†’ **å…ˆå¤©åŽå—**
2. âœ… NODATAå¤„ç†ï¼šç¡¬ç¼–ç  â†’ **è¯»å–çœŸå®žå€¼**
3. âœ… ç‰©å€™æ£€æŸ¥ï¼šmaskæ£€æŸ¥ â†’ **valid_phenoæ£€æŸ¥**
4. âœ… æµ‹è¯•æ—¥æœŸï¼š2000å¹´ â†’ **YEAR_START(1982)**
5. âœ… æç¤ºä¿¡æ¯ï¼šé”™è¯¯ç¤ºä¾‹ â†’ **æ­£ç¡®ç¤ºä¾‹**

---

## âœ… ä¼˜åŒ–ç¡®è®¤

- [x] å¾ªçŽ¯é¡ºåºå·²æ”¹ä¸º"å…ˆå¤©åŽå—"ï¼ˆæ€§èƒ½ï¼‰
- [x] NODATAä½¿ç”¨çœŸå®žå€¼ï¼ˆæ•°æ®æ­£ç¡®æ€§ï¼‰
- [x] valid_phenoæ£€æŸ¥å·²æ·»åŠ ï¼ˆæ•°æ®æ­£ç¡®æ€§ï¼‰
- [x] æµ‹è¯•æ—¥æœŸå·²ä¿®æ­£
- [x] æç¤ºä¿¡æ¯å·²ä¿®æ­£
- [x] CHANGELOGå·²æ›´æ–°
- [x] ä»£ç å®Œæ•´æ€§å·²éªŒè¯

**æ‰€æœ‰ä¼˜åŒ–å·²å®Œæˆï¼å¯ä»¥å¼€å§‹è¿è¡Œ** ðŸŽ‰

---

**ä¸‹ä¸€æ­¥**: è¿è¡Œ `python 02_TRc_calculation.py`ï¼Œé¢„è®¡ 20-30 åˆ†é’Ÿå®Œæˆæ‰€æœ‰å¹´ä»½ï¼

**æŸ¥çœ‹è¯¦ç»†è®°å½•**: [CHANGELOG.md](CHANGELOG.md) â†’ ç‰ˆæœ¬ 1.3.0
