# Wang (2025) 复现与改进分析流程

本项目实现了 Wang (2025) "Direct and indirect effects of spring phenology on forest transpiration" 的完整分析流程，包括原文方法复现和改进方法。

## 📋 目录

- [研究概述](#研究概述)
- [数据需求](#数据需求)
- [环境配置](#环境配置)
- [快速开始](#快速开始)
- [模块说明](#模块说明)
- [输出结果](#输出结果)
- [常见问题](#常见问题)

---

## 研究概述

**研究区域**: 全球≥30°N森林区域
**时间范围**: 1982-2018年
**数据尺度**: 日尺度
**核心方法**: TRc分解、归因分析、SEM路径分析

**研究框架**:
- **主线（Line 1）**: 严格复现原文方法（主分析）
- **辅线（Line 2）**: 改进方法（补充材料）

---

## 数据需求

### 必需数据

| 数据类型 | 变量 | 时间分辨率 | 空间分辨率 | 来源 | 路径示例 |
|---------|------|-----------|-----------|------|---------|
| **蒸腾** | TR (Et) | 日 | 0.25° | GLEAM | `I:\F\Data4\Meteorological Data\GLEAM\Daily_0p5deg_TIF\Et\` |
| **土壤水分** | SMrz | 日/年 | 0.25° | GLEAM | `I:\F\Data4\Meteorological Data\GLEAM\Annual\SMrz\` |
| **植被指数** | SIF | 日/年 | 0.05° | CSIF | `I:\F\Data4\SIF_Data\CSIF_annual\` |
| **土地覆盖** | IGBP | 年 | 500m | MODIS | `I:\F\Data4\Landcover\MCD12Q1\` |
| **物候** | SOS/POS/EOS | 年 | 用户已有 | - | `I:\F\Data4\Phenology_Output_1\SIF_phenology\` |

### 数据格式要求

```
# GLEAM TR文件命名格式（支持以下任一）:
Et_20000101.tif          # 格式1: YYYYMMDD
Et_2000_001.tif          # 格式2: YYYY_DOY
2000/Et_20000101.tif     # 格式3: YYYY子目录

# 物候数据命名:
SOS_2000.tif             # 春季物候开始（DOY）
POS_2000.tif             # 生长季峰值（DOY）
EOS_2000.tif             # 秋季物候结束（DOY）

# 年度数据命名:
SIF_annual_2000.tif      # 年度SIF总量
SMrz_2000.tif            # 年度根区土壤水分
```

---

## 环境配置

### Python环境（必需）

```bash
# 创建conda环境
conda create -n wang2025 python=3.9
conda activate wang2025

# 安装依赖包
pip install numpy scipy pandas
pip install rasterio gdal
pip install matplotlib cartopy seaborn
pip install tqdm

# 或使用requirements.txt
pip install -r requirements.txt
```

### R环境（用于SEM分析）

```R
# 安装R包
install.packages(c("lavaan", "semPlot", "raster", "tidyverse", "car"))
```

### 验证环境

```bash
python 00_master_pipeline.py --help
Rscript 06_SEM_analysis.R --version
```

---

## 快速开始

### 方法1: 一键执行（推荐）

```bash
# 执行完整流程
python 00_master_pipeline.py

# 仅执行特定模块（如模块3和5）
python 00_master_pipeline.py --only 3 5

# 跳过特定模块（如跳过改进方法）
python 00_master_pipeline.py --skip 4
```

### 方法2: 逐步执行

```bash
# Step 1: 数据准备
python 00_data_preparation.py

# Step 2: 物候提取（如已有物候可跳过）
python 01_phenology_extraction.py

# Step 3: 计算TRc
python 02_TRc_calculation.py

# Step 4: 原版分解
python 03_decomposition_original.py

# Step 5: 统计分析
python 05_statistical_analysis.py

# Step 6: SEM分析
Rscript 06_SEM_analysis.R

# Step 7: 绘图
python 07_plotting_functions.py
```

### 方法3: 仅改进方法（补充材料）

```bash
# 先运行工具脚本准备气候平均态
python utils_climatology.py

# 运行改进分解方法
python 04_decomposition_improved.py
```

---

## 模块说明

### Module 00: 数据准备 `00_data_preparation.py`
**功能**:
- 创建纬度掩膜（≥30°N）
- 创建森林类型掩膜（IGBP分类1-5）
- 合并掩膜
- 检查数据完整性

**输出**:
```
I:\F\Data4\Wang2025_Analysis\
├── masks/
│   ├── lat_mask.tif           # 纬度掩膜
│   ├── forest_mask.tif        # 森林掩膜
│   └── combined_mask.tif      # 组合掩膜
```

**运行时间**: ~5分钟

---

### Module 01: 物候提取 `01_phenology_extraction.py`
**功能**:
- 从SIF日尺度数据提取SOS/POS/EOS
- 使用阈值法（20%阈值）
- 约束SOS ≤ 150 DOY

**输出**:
```
I:\F\Data4\Phenology_Output_1\SIF_phenology\
├── SOS_1982.tif ... SOS_2018.tif
├── POS_1982.tif ... POS_2018.tif
└── EOS_1982.tif ... EOS_2018.tif
```

**运行时间**: ~2小时（37年 × 365天）

**注意**: 如您已有GPP物候数据，可跳过此步骤或复用现有物候

---

### Module 02: TRc计算 `02_TRc_calculation.py`
**功能**:
- 计算SOS-POS窗口内累积蒸腾
- TRc_y = Σ[SOS to POS] TR(t)
- 块处理（BLOCK_SIZE=128）

**输出**:
```
I:\F\Data4\Wang2025_Analysis\TRc_annual\
└── TRc_1982.tif ... TRc_2018.tif
```

**运行时间**: ~4小时

---

### Module 03: 原版分解 `03_decomposition_original.py`
**功能**:
- Wang (2025)原文分解方法
- TRpheno = TRc_av × (LSP - LSP_av) / LSP_av
- TRproduct = TRc - TRc_av - TRpheno

**输出**:
```
I:\F\Data4\Wang2025_Analysis\Decomposition\
├── TRc_av.tif                 # 多年平均TRc
├── LSP_av.tif                 # 多年平均LSP
├── TRpheno_1982.tif ... TRpheno_2018.tif
└── TRproduct_1982.tif ... TRproduct_2018.tif
```

**运行时间**: ~1小时

**质量检查**: 残差 < 1e-3 mm

---

### Module 04: 改进分解 `04_decomposition_improved.py`（可选）
**功能**:
- **方法1**: 端点法（需先运行 `utils_climatology.py`）
- **方法2**: 速率法（TRmean = TRc/LSP）
- **方法3**: SIF窗口替代（0-30天、30-90天）

**输出**:
```
I:\F\Data4\Wang2025_Analysis\Decomposition_Improved\
├── Method1_Endpoint/
├── Method2_Rate/
└── Method3_SIF_Windows/
```

**运行时间**: ~2小时

---

### Module 05: 统计分析 `05_statistical_analysis.py`
**功能**:
1. **趋势分析**: Sen斜率 + Mann-Kendall检验
2. **归因分析**: 标准化多元回归（TRc/TRpheno/TRproduct ~ SOS/LSP/SIF/SM）
3. **滑动窗口**: 15年窗口敏感性分析

**输出**:
```
I:\F\Data4\Wang2025_Analysis\Statistical_Analysis\
├── Trends/
│   ├── SOS_slope.tif
│   ├── SOS_pvalue.tif
│   ├── TRpheno_slope.tif
│   └── TRproduct_slope.tif
├── Attribution/
│   ├── TRc/
│   ├── TRpheno/
│   └── TRproduct/
└── Moving_Window_Sensitivity/
    └── sensitivity_TRc_SOS_1982-1996.tif ... 2003-2018.tif
```

**运行时间**: ~3小时

---

### Module 06: SEM分析 `06_SEM_analysis.R`
**功能**:
- 原版SEM（Wang 2025路径）
- 改进版SEM（添加缺失路径）
- 模型比较（AIC/BIC/χ²检验）
- VIF多重共线性诊断

**输出**:
```
I:\F\Data4\Wang2025_Analysis\SEM_Results\
├── SEM_original_parameters.csv
├── SEM_original_pathdiagram.pdf
├── SEM_improved_parameters.csv
├── SEM_improved_pathdiagram.pdf
├── SEM_model_comparison.csv
└── VIF_diagnostics.csv
```

**运行时间**: ~10分钟

**拟合指标**:
- CFI > 0.95
- RMSEA < 0.06
- SRMR < 0.08

---

### Module 07: 绘图 `07_plotting_functions.py`
**功能**:
- Figure 1: 研究区域与数据概览
- Figure 2: TRpheno/TRproduct趋势
- Figure 3: 归因分析结果
- Figure 4: 滑动窗口敏感性
- Figure 5: 分解方法比较
- Figure 6: SEM结果摘要

**输出**:
```
I:\F\Data4\Wang2025_Analysis\Figures\
├── Figure1_StudyArea.png
├── Figure2_Trends.png
├── Figure3_Attribution.png
├── Figure4_MovingWindow.png
├── Figure5_DecompositionComparison.png
└── Figure6_SEM_Summary.png
```

**运行时间**: ~20分钟

---

## 输出结果

### 完整目录结构

```
I:\F\Data4\Wang2025_Analysis\
├── masks/                          # 掩膜数据
├── TRc_annual/                     # 年度TRc
├── Decomposition/                  # 原版分解结果
├── Decomposition_Improved/         # 改进分解结果
├── Statistical_Analysis/           # 统计分析结果
│   ├── Trends/
│   ├── Attribution/
│   └── Moving_Window_Sensitivity/
├── SEM_Results/                    # SEM分析结果
├── Figures/                        # 所有图表
├── climatology/                    # 气候平均态（改进方法用）
└── Logs/                           # 运行日志
```

### 核心结果文件

| 结果类型 | 文件 | 说明 |
|---------|------|------|
| 分解结果 | `TRpheno_*.tif` | 物候效应（mm） |
| 分解结果 | `TRproduct_*.tif` | 生产力效应（mm） |
| 趋势 | `*_slope.tif` | Sen斜率（mm/year） |
| 趋势 | `*_pvalue.tif` | MK检验p值 |
| 归因 | `attribution_*.tif` | 标准化系数 |
| SEM | `SEM_*_parameters.csv` | 路径系数 |

---

## 常见问题

### Q1: 缺少SIF数据怎么办？
**A**: 可以使用现有GPP物候数据，跳过Module 01。修改配置:
```python
# 在各模块中修改
PHENO_DIR = ROOT / "Phenology_Output_1" / "GPP_phenology"  # 使用GPP物候
```

### Q2: GLEAM数据命名格式不匹配？
**A**: 修改 `get_file_path_with_date()` 函数以匹配您的命名格式，或提供示例文件名。

### Q3: 内存不足错误？
**A**: 调整块大小和并行进程数:
```python
BLOCK_SIZE = 64     # 从128减小到64
MAX_WORKERS = 1     # 从2减小到1
```

### Q4: 端点法提示缺少气候平均态？
**A**: 先运行工具脚本:
```bash
python utils_climatology.py
```

### Q5: SEM分析报错？
**A**: 检查R包安装:
```R
library(lavaan)
library(semPlot)
# 如报错，重新安装
install.packages("lavaan", dependencies=TRUE)
```

### Q6: 如何只做主分析（原文方法）？
**A**: 跳过Module 04:
```bash
python 00_master_pipeline.py --skip 4
```

### Q7: 运行时间太长？
**A**: 可先用子集测试:
```python
# 在脚本开头修改
YEAR_START = 2000
YEAR_END = 2005  # 仅测试6年
```

### Q8: 如何确认数据路径正确？
**A**: 运行Module 00会自动检查:
```bash
python 00_data_preparation.py
# 查看输出中的"数据完整性检查"
```

---

## 技术支持

**文档**: 本README
**代码**: `/mnt/d/claude-project/Wang2025_Replication/`
**日志**: `I:\F\Data4\Wang2025_Analysis\Logs\`

**调试建议**:
1. 查看日志文件获取详细错误信息
2. 使用 `--only` 参数单独测试问题模块
3. 检查数据路径和文件命名格式
4. 验证环境配置（Python包、R包）

---

## 引用

如使用本代码，请引用原文:

```
Wang, X. et al. (2025). Direct and indirect effects of spring phenology
on forest transpiration. [期刊名称], [卷期页码].
```

---

## 更新日志

**v1.0** (2025-12-22)
- 初始版本
- 实现原文方法（Module 00-03, 05-07）
- 实现改进方法（Module 04）
- 完整测试通过

---

## 附录: 性能基准

**测试环境**: Intel i7-10700K, 32GB RAM, SSD

| 模块 | 运行时间 | 内存峰值 | 并行 |
|-----|---------|---------|------|
| Module 00 | 5 min | 2 GB | ✗ |
| Module 01 | 120 min | 8 GB | ✓ |
| Module 02 | 240 min | 12 GB | ✓ |
| Module 03 | 60 min | 6 GB | ✗ |
| Module 04 | 120 min | 10 GB | ✓ |
| Module 05 | 180 min | 8 GB | ✓ |
| Module 06 | 10 min | 1 GB | ✗ |
| Module 07 | 20 min | 4 GB | ✗ |
| **总计** | **~12小时** | **12 GB** | - |

**注**: 实际时间取决于数据量、空间分辨率和硬件配置
