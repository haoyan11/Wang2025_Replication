# 土壤水分格式修正说明

**修改日期**: 2025-12-23
**版本**: 1.2.0

---

## ✅ 修改完成总结

根据您提供的信息，已完成以下修改：

### 📋 您的数据格式

1. **土壤水分**: `SMrz_19801218.tif` → **日尺度** ⭐
2. **土地覆盖**: 文件不存在 → **不影响当前分析** ✅

---

## 🎯 修改的文件（3个）

### 1. config.py
**修改内容**:
- ✅ 更新SM文件格式: `SMrz_YYYYMM.tif` → `SMrz_YYYYMMDD.tif`
- ✅ 新增 `get_SM_file_path()` 函数（类似 `get_TR_file_path()`）

**具体位置**:
- 第93-96行: 文件格式配置
- 第185-207行: 新增函数

### 2. verify_data.py
**修改内容**:
- ✅ 更新SM数据检查为日尺度（测试日期：1982-01-15, 2000-06-15, 2018-12-15）
- ✅ 土地覆盖数据检查改为可选（仅在 `USE_FOREST_MASK=True` 时检查）

**具体位置**:
- 第13行: 导入 `USE_FOREST_MASK`
- 第117-143行: `check_SM_data()` 函数
- 第160-166行: 土地覆盖检查逻辑

### 3. 数据配置说明.md
**修改内容**:
- ✅ 更新SM格式说明为日尺度
- ✅ 强调日尺度数据的优势

**具体位置**:
- 第27-43行: SM数据格式章节

### 4. README.md
**修改内容**:
- ✅ 更新数据格式表（第58行）
- ✅ 更新注意事项，强调SM日尺度优势（第159-168行）
- ✅ 说明土地覆盖数据在当前配置下不需要

---

## 📊 数据格式对比

### 修改前 vs 修改后

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| **SM格式** | `SMrz_YYYYMM.tif` | `SMrz_YYYYMMDD.tif` ⭐ |
| **SM示例** | `SMrz_198201.tif` | `SMrz_19801218.tif` |
| **时间分辨率** | 月尺度 | **日尺度** |
| **是否需要插值** | ✅ 需要 | ✅ **不需要** |

---

## 🎉 日尺度数据的优势

### 您的数据配置非常理想！

✅ **完美匹配**:
```
TR（蒸腾）: 日尺度 ✓
GPP:       日尺度 ✓
SM（土壤水分）: 日尺度 ✓ ← 您的数据
```

✅ **优势**:
1. **无需插值** - 所有数据时间分辨率一致
2. **精度更高** - 可以捕捉短期土壤水分变化
3. **分析更准确** - 逐日分析无时间滞后
4. **比月尺度强** - 能够识别极端干湿事件

---

## ⚠️ 关于土地覆盖数据

### 问题
```
✗ MODIS IGBP: I:\F\Data4\Landcover\MCD12Q1\MCD12Q1_IGBP_2018.tif
  文件不存在!
```

### 影响分析

✅ **完全不影响当前分析！**

**原因**:
1. 当前配置 `USE_FOREST_MASK = False`（全局分析模式）
2. 土地覆盖数据**仅在**切换到仅森林模式时才需要
3. 您采用"先全局分析，后植被分层"的工作流程
4. 现在 `verify_data.py` 会智能跳过这个检查

### 何时需要？

**仅在以下两种情况需要土地覆盖数据**:

#### 情况1: 切换到仅森林模式
```python
# 编辑 config.py
USE_FOREST_MASK = True  # 改为True
```

#### 情况2: 运行植被分层分析
```bash
python utils_vegetation_stratification.py
```

**届时**您再准备土地覆盖数据即可。

---

## 🚀 测试修改

### 立即测试

```bash
cd D:\claude-project\Wang2025_Replication

# 测试数据验证（应该不再报错）
python verify_data.py
```

### 预期输出

```
======================================================================
Wang2025 数据验证脚本
======================================================================

[1] 检查关键目录:
  ✓ 根目录: I:\F\Data4
  ✓ TR数据目录: ...
  ✓ 物候数据目录: ...
  ✓ GPP数据目录: ...
  ✓ 土壤水分目录: ...

  土地覆盖数据 (USE_FOREST_MASK=False):
    ⚠ 跳过检查（当前为全局分析模式，仅在仅森林模式时需要）  ← 不再报错

[5] 检查土壤水分数据 (SMrz深层，日尺度):  ← 改为日尺度
  ✓ 1982-01-15: SMrz_19820115.tif
  ✓ 2000-06-15: SMrz_20000615.tif
  ✓ 2018-12-15: SMrz_20181215.tif
  ✓ 抽样检查通过 (3/3)
```

---

## 📝 修改记录

所有修改已记录到 [CHANGELOG.md](CHANGELOG.md)，您可以随时查看：

```bash
# 查看修改记录
cat CHANGELOG.md
```

或打开文件查看 **[1.2.0] - 2025-12-23** 版本的详细修改内容。

---

## 🎯 下一步

### 1. 验证数据
```bash
python verify_data.py
```

### 2. 准备掩膜
```bash
python 00_data_preparation.py
```

### 3. 运行分析
```bash
python 00_master_pipeline.py
```

---

## ❓ 常见问题

### Q1: 为什么土地覆盖数据不需要？
**A**: 当前配置 `USE_FOREST_MASK = False`，仅使用纬度掩膜（≥30°N），不筛选森林。植被分层会在分析完成后使用 `utils_vegetation_stratification.py` 进行。

### Q2: 日尺度SM数据比月尺度好在哪里？
**A**:
- ✅ 与TR、GPP时间分辨率一致，无需插值
- ✅ 可以捕捉短期土壤水分变化（如降雨后快速干燥）
- ✅ 逐日分析更精确，无时间滞后

### Q3: 如何检查SM数据是否正确？
**A**: 运行 `python verify_data.py`，检查第5项"土壤水分数据"是否通过。

### Q4: 后续如何获取土地覆盖数据？
**A**:
1. 从 [MODIS官网](https://lpdaac.usgs.gov/products/mcd12q1v006/) 下载
2. 或使用 Google Earth Engine 导出
3. 仅在需要植被分层分析时下载即可

---

## ✅ 修改完成确认

- [x] config.py - SM格式和函数已更新
- [x] verify_data.py - SM检查和土地覆盖检查已更新
- [x] 数据配置说明.md - SM格式说明已更新
- [x] README.md - 数据格式表和注意事项已更新
- [x] CHANGELOG.md - 修改记录已添加
- [x] 本说明文档已创建

**所有修改已完成！可以开始数据验证了** 🎉

---

**查看详细修改记录**: [CHANGELOG.md](CHANGELOG.md) → 版本 1.2.0
**查看配置详解**: [数据配置说明.md](数据配置说明.md)
**查看主文档**: [README.md](README.md)
