# TRcè®¡ç®—ä¼˜åŒ–è¯´æ˜Ž (v1.3.1)

**ä¼˜åŒ–æ—¥æœŸ**: 2025-12-23
**ç‰ˆæœ¬**: 1.3.1ï¼ˆè¡¥å……æ›´æ–°ï¼‰

---

## âœ… ä¼˜åŒ–å®Œæˆæ€»ç»“

å·²å®Œæˆ [02_TRc_calculation.py](02_TRc_calculation.py) çš„æ€§èƒ½å’Œæ•°æ®æ­£ç¡®æ€§å…¨é¢ä¼˜åŒ–ï¼Œå¹¶è¡¥å……äº†æ–­ç‚¹ç»­ç®—å’Œå¹¶è¡Œå¤„ç†åŠŸèƒ½ã€‚

---

## ðŸš€ ä¸‰å¤§æ ¸å¿ƒä¼˜åŒ–

### 1. å¾ªçŽ¯é¡ºåºä¼˜åŒ– - æ€§èƒ½æå‡18å€+

#### ä¿®æ”¹å‰ï¼ˆæ…¢ï¼‰
```python
for å— in å—åˆ—è¡¨:  # 18ä¸ªå—
    for å¤© in 365å¤©:
        æ‰“å¼€TRæ–‡ä»¶  # âŒ 18 Ã— 365 = 6,570æ¬¡æ–‡ä»¶æ‰“å¼€ï¼ˆæ¯å¹´ï¼‰
```

#### ä¿®æ”¹åŽï¼ˆå¿«ï¼‰
```python
for å¤© in 365å¤©:
    æ‰“å¼€TRæ–‡ä»¶ä¸€æ¬¡  # âœ… æ¯å¤©åªæ‰“å¼€1æ¬¡ = 365æ¬¡ï¼ˆæ¯å¹´ï¼‰
    for å— in å—åˆ—è¡¨:
        è¯»å–windowæ•°æ®
```

**æ€§èƒ½å½±å“**:
- æ–‡ä»¶æ‰“å¼€æ¬¡æ•°ï¼šä»Ž ~24ä¸‡æ¬¡ â†’ ~1.3ä¸‡æ¬¡ï¼ˆ37å¹´ï¼‰
- **é¢„è®¡è¿è¡Œæ—¶é—´ï¼šä»Ž 6-8å°æ—¶ â†’ 20-30åˆ†é’Ÿ** â­

---

### 2. NODATAä¸€è‡´æ€§ä¿®å¤ - æ•°æ®æ­£ç¡®æ€§

#### é—®é¢˜
```python
# ç¡¬ç¼–ç NODATA = -9999
if tr_value != -9999:  # âŒ ERA5-Landçš„nodataå¯èƒ½æ˜¯nanæˆ–3e38
    ç´¯åŠ 
```

**é£Žé™©**: çœŸå®žnodataè¢«å½“æˆæœ‰æ•ˆå€¼ç´¯åŠ ï¼Œå¯¼è‡´TRcå¼‚å¸¸å·¨å¤§ã€‚

#### ä¿®å¤
```python
# è¯»å–æ …æ ¼çœŸå®žnodata
with rasterio.open(file) as src:
    nodata_tr = src.nodata  # âœ… å¯èƒ½æ˜¯nanã€3e38ç­‰

# æ­£ç¡®åˆ¤æ–­
if nodata_tr is None:
    valid = np.isfinite(tr)
elif np.isnan(nodata_tr):
    valid = np.isfinite(tr)
else:
    valid = (tr != nodata_tr) & np.isfinite(tr)
```

---

### 3. valid_phenoæ£€æŸ¥ - æ•°æ®æ­£ç¡®æ€§

#### é—®é¢˜
```python
TRc[mask] = 0.0  # âŒ åªè¦mask=Trueå°±åˆå§‹åŒ–ä¸º0

# å¦‚æžœæŸåƒå…ƒmask=Trueä½†SOS/POSæ— æ•ˆ
# â†’ æ°¸è¿œä¸ç´¯åŠ  â†’ TRc=0 â†’ è¢«è¯¯è®¤ä¸º"è’¸è…¾ä¸º0"
```

#### ä¿®å¤
```python
# æ£€æŸ¥ç‰©å€™æœ‰æ•ˆæ€§
valid_pheno = (
    mask
    & _is_valid_pheno(sos, nodata_sos)
    & _is_valid_pheno(pos, nodata_pos)
    & (sos > 0) & (pos > 0)
    & (pos >= sos)
    & (sos <= days_in_year) & (pos <= days_in_year)
)

# åªå¯¹æœ‰æ•ˆåƒå…ƒåˆå§‹åŒ–ä¸º0
TRc = np.full((height, width), NODATA_OUT)
TRc[valid_pheno] = 0.0  # âœ… æ— æ•ˆç‰©å€™â†’NODATAï¼Œæœ‰æ•ˆç‰©å€™â†’0
```

---

## ðŸ“Š ä¼˜åŒ–æ•ˆæžœå¯¹æ¯”

| é¡¹ç›® | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æå‡ |
|------|--------|--------|------|
| **è¿è¡Œæ—¶é—´** | 6-8å°æ—¶ | 20-30åˆ†é’Ÿ | **18å€+** â­ |
| **æ–‡ä»¶æ‰“å¼€æ¬¡æ•°** | ~24ä¸‡æ¬¡ | ~1.3ä¸‡æ¬¡ | **å‡å°‘95%** |
| **NODATAå¤„ç†** | âŒ ç¡¬ç¼–ç  | âœ… çœŸå®žå€¼ | **ä¿®å¤æ•°æ®é”™è¯¯é£Žé™©** |
| **ç‰©å€™æ£€æŸ¥** | âŒ æ— æ•ˆâ†’0 | âœ… æ— æ•ˆâ†’NODATA | **ä¿®å¤æ•°æ®æ··æ·†** |
| **å†…å­˜å ç”¨** | ä½Ž | ä½Ž | ä¿æŒä¸å˜ |

---

## ðŸŽ¯ ä¿®æ”¹çš„æ–‡ä»¶

### 1. [02_TRc_calculation.py](02_TRc_calculation.py)

**ä¿®æ”¹ä½ç½®**:
- ç¬¬158-307è¡Œ: `calculate_TRc_block_optimized()` å‡½æ•°ï¼ˆå®Œå…¨é‡å†™ï¼‰
- ç¬¬341è¡Œ: `main()` æµ‹è¯•æ—¥æœŸæ”¹ä¸º `YEAR_START`
- ç¬¬347è¡Œ: `main()` æç¤ºä¿¡æ¯ä¿®æ­£

**è¯¦ç»†å˜æ›´**: è§ [CHANGELOG.md](CHANGELOG.md) â†’ ç‰ˆæœ¬ 1.3.0

---

### 2. [CHANGELOG.md](CHANGELOG.md)

æ–°å¢žç‰ˆæœ¬ 1.3.0ï¼Œè¯¦ç»†è®°å½•æ‰€æœ‰ä¼˜åŒ–å†…å®¹ã€‚

---

## ðŸš€ çŽ°åœ¨å¯ä»¥è¿è¡Œäº†

### è¿è¡Œå‘½ä»¤
```bash
cd D:\claude-project\Wang2025_Replication
python 02_TRc_calculation.py
```

### é¢„æœŸæ—¶é—´
- **ä¼˜åŒ–å‰**: 6-8å°æ—¶
- **ä¼˜åŒ–åŽ**: **20-30åˆ†é’Ÿ** â­

### è¾“å‡ºç»“æžœ
```
Wang2025_Analysis/TRc_annual/
â”œâ”€â”€ TRc_1982.tif
â”œâ”€â”€ TRc_1983.tif
...
â””â”€â”€ TRc_2018.tif  # å…±37ä¸ªæ–‡ä»¶
```

---

## âœ¨ è¡¥å……åŠŸèƒ½ï¼ˆv1.3.1ï¼‰

### 4. æ–­ç‚¹ç»­ç®—åŠŸèƒ½ â­

**åŠŸèƒ½**: è‡ªåŠ¨è·³è¿‡å·²å­˜åœ¨çš„è¾“å‡ºæ–‡ä»¶

**ä½¿ç”¨æ–¹æ³•**: æ— éœ€é…ç½®ï¼Œè‡ªåŠ¨å¯ç”¨
```bash
# ç¨‹åºä¸­æ–­åŽï¼Œç›´æŽ¥é‡æ–°è¿è¡Œå³å¯
python 02_TRc_calculation.py
```

**è¾“å‡ºç¤ºä¾‹**:
```
é€å¹´è®¡ç®—TRc (1982-2018)...
  âš  è·³è¿‡å·²å­˜åœ¨: 1982 (TRc_1982.tif)
  âš  è·³è¿‡å·²å­˜åœ¨: 1983 (TRc_1983.tif)
  === è®¡ç®—TRcï¼ˆå—å¤„ç†-åŠ é€Ÿç‰ˆï¼‰: 1984 ===
  ...
```

**é€‚ç”¨åœºæ™¯**:
- ç¨‹åºæ„å¤–ä¸­æ–­åŽé‡æ–°è¿è¡Œ
- ä»…éœ€é‡æ–°è®¡ç®—éƒ¨åˆ†å¹´ä»½
- è°ƒè¯•ç‰¹å®šå¹´ä»½æ•°æ®

---

### 5. å¹¶è¡Œå¤„ç†åŠŸèƒ½ â­

**åŠŸèƒ½**: å¹´åº¦å¹¶è¡Œå¤„ç†ï¼Œè¿›ä¸€æ­¥æé€Ÿ

**ä½¿ç”¨æ–¹æ³•**: åœ¨ `__main__` ä¸­å¯ç”¨
```python
# ç¼–è¾‘ 02_TRc_calculation.py æœ€åŽå‡ è¡Œ
if __name__ == "__main__":
    # æ³¨é‡ŠæŽ‰åŽŸä¸²è¡Œç‰ˆæœ¬
    # main(use_block_processing=True)

    # å¯ç”¨å¹¶è¡Œç‰ˆæœ¬ï¼ˆ2-4ä¸ªè¿›ç¨‹ï¼‰
    main_parallel(use_block_processing=True, max_workers=2)
```

**æ€§èƒ½å¯¹æ¯”**:
| çŽ¯å¢ƒ | ä¸²è¡Œç‰ˆæœ¬ | å¹¶è¡Œç‰ˆæœ¬(2è¿›ç¨‹) | æå‡ |
|------|---------|---------------|------|
| SSD | 20-30åˆ†é’Ÿ | 15-25åˆ†é’Ÿ | 30-50% |
| HDD | 20-30åˆ†é’Ÿ | âš ï¸ å¯èƒ½æ›´æ…¢ | âŒ ä¸æŽ¨è |

**æ³¨æ„äº‹é¡¹**:
- âœ… æŽ¨èSSDå­˜å‚¨çŽ¯å¢ƒ
- âœ… MAX_WORKERS=2-4 æ¯”è¾ƒç¨³å¦¥
- âŒ HDDçŽ¯å¢ƒä¸æŽ¨èï¼ˆI/Oç«žäº‰ï¼‰
- âœ… è‡ªåŠ¨æ”¯æŒæ–­ç‚¹ç»­ç®—

---

### 6. ç»Ÿè®¡ä¿¡æ¯è¾“å‡º

**åŠŸèƒ½**: æ˜¾ç¤ºå¤„ç†ç»Ÿè®¡

**è¾“å‡ºç¤ºä¾‹**:
```
âœ“ TRcè®¡ç®—å®Œæˆï¼
è¾“å‡ºç›®å½•: I:\F\Data4\Wang2025_Analysis\TRc_annual

ç»Ÿè®¡:
  - æ–°å¤„ç†: 35 ä¸ªå¹´ä»½
  - å·²è·³è¿‡: 2 ä¸ªå¹´ä»½ï¼ˆæ–‡ä»¶å·²å­˜åœ¨ï¼‰
  - æ€»è®¡: 37 ä¸ªå¹´ä»½
```

**å¥½å¤„**:
- æ¸…æ™°äº†è§£å¤„ç†çŠ¶æ€
- å¿«é€Ÿå®šä½å¤±è´¥å¹´ä»½
- ä¾¿äºŽéªŒè¯å®Œæ•´æ€§

---

## ðŸ“ ä¿®æ”¹è®°å½•

**å®Œæ•´ä¿®æ”¹è®°å½•**: [CHANGELOG.md](CHANGELOG.md) â†’ ç‰ˆæœ¬ 1.3.0

**ä¸»è¦å˜æ›´**:
1. âœ… å¾ªçŽ¯é¡ºåºï¼šå…ˆå—åŽå¤© â†’ **å…ˆå¤©åŽå—**
2. âœ… NODATAå¤„ç†ï¼šç¡¬ç¼–ç  â†’ **è¯»å–çœŸå®žå€¼**
3. âœ… ç‰©å€™æ£€æŸ¥ï¼šmaskæ£€æŸ¥ â†’ **valid_phenoæ£€æŸ¥**
4. âœ… æµ‹è¯•æ—¥æœŸï¼š2000å¹´ â†’ **YEAR_START(1982)**
5. âœ… æç¤ºä¿¡æ¯ï¼šé”™è¯¯ç¤ºä¾‹ â†’ **æ­£ç¡®ç¤ºä¾‹**

---

## âœ… ä¼˜åŒ–ç¡®è®¤ï¼ˆv1.3.1ï¼‰

### æ ¸å¿ƒä¼˜åŒ–ï¼ˆv1.3.0ï¼‰
- [x] å¾ªçŽ¯é¡ºåºå·²æ”¹ä¸º"å…ˆå¤©åŽå—"ï¼ˆæ€§èƒ½ï¼‰
- [x] NODATAä½¿ç”¨çœŸå®žå€¼ï¼ˆæ•°æ®æ­£ç¡®æ€§ï¼‰
- [x] valid_phenoæ£€æŸ¥å·²æ·»åŠ ï¼ˆæ•°æ®æ­£ç¡®æ€§ï¼‰
- [x] æµ‹è¯•æ—¥æœŸå·²ä¿®æ­£
- [x] æç¤ºä¿¡æ¯å·²ä¿®æ­£

### è¡¥å……åŠŸèƒ½ï¼ˆv1.3.1ï¼‰
- [x] æ–­ç‚¹ç»­ç®—åŠŸèƒ½å·²æ·»åŠ 
- [x] å¹¶è¡Œå¤„ç†åŠŸèƒ½å·²æ·»åŠ 
- [x] ç»Ÿè®¡ä¿¡æ¯è¾“å‡ºå·²æ·»åŠ 
- [x] éžå—ç‰ˆæœ¬æ³¨é‡Šå·²ä¿®æ­£
- [x] CHANGELOGå·²æ›´æ–°ï¼ˆç‰ˆæœ¬1.3.1ï¼‰
- [x] ä»£ç å®Œæ•´æ€§å·²éªŒè¯

**æ‰€æœ‰ä¼˜åŒ–å·²å®Œæˆï¼å¯ä»¥å¼€å§‹è¿è¡Œ** ðŸŽ‰

---

## ðŸ“Š ç‰ˆæœ¬åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | v1.2.1 | v1.3.0 | v1.3.1 |
|------|--------|--------|--------|
| å¾ªçŽ¯ä¼˜åŒ– | âŒ | âœ… | âœ… |
| NODATAä¿®å¤ | âŒ | âœ… | âœ… |
| valid_pheno | âŒ | âœ… | âœ… |
| æ–­ç‚¹ç»­ç®— | âŒ | âŒ | âœ… |
| å¹¶è¡Œå¤„ç† | âŒ | âŒ | âœ… (å¯é€‰) |
| ç»Ÿè®¡è¾“å‡º | âŒ | âŒ | âœ… |
| è¿è¡Œæ—¶é—´ | 6-8å°æ—¶ | 20-30åˆ†é’Ÿ | 15-30åˆ†é’Ÿ |

---

**ä¸‹ä¸€æ­¥**: è¿è¡Œ `python 02_TRc_calculation.py`

**æŸ¥çœ‹è¯¦ç»†è®°å½•**:
- [CHANGELOG.md](CHANGELOG.md) â†’ ç‰ˆæœ¬ 1.3.1ï¼ˆè¡¥å……åŠŸèƒ½ï¼‰
- [CHANGELOG.md](CHANGELOG.md) â†’ ç‰ˆæœ¬ 1.3.0ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼‰
