# Wang (2025) 复现项目文档

**项目名称**: 春季物候对森林蒸腾的直接和间接影响  
**当前版本**: v1.2.2 (2025-01-10)  
**文档更新**: 2025-01-10

---

## 📑 文档目录

1. [文档导航](#1-文档导航) - 快速索引
2. [快速开始指南](#2-快速开始指南) - 运行前检查清单
3. [数据配置说明](#3-数据配置说明) - 路径配置与数据格式
4. [修改记录](#4-修改记录) - 版本历史与重要修复
5. [项目修改总结](#5-项目修改总结) - 已完成的所有修改
6. [三种方法对比](#6-三种方法对比) - 分解方法输出对比
7. [结果诊断](#7-结果诊断) - 统计结果差异分析

---

# 1. 文档导航

## 🚀 快速入门

### 新手必读
1. **[../使用说明.md](../使用说明.md)** - 项目概述、快速开始 ⭐ 从这里开始
2. **本文档 §2** - 快速开始指南（5分钟了解流程）
3. **[requirements.txt](../requirements.txt)** - Python环境依赖

---

## 📖 使用指南

- **本文档 §3** - 数据配置说明：数据路径配置、格式要求、准备步骤

---

## 📝 修改总结

### ⭐⭐ 推荐阅读
- **本文档 §5** - 项目修改总结：所有修改的完整汇总
- **本文档 §4** - 修改记录：按版本组织的变更历史

---

## 📊 分析报告

- **本文档 §6** - 三种方法对比：分解方法输出文件对比
- **本文档 §7** - 结果诊断：统计结果差异分析

---

## 🔧 核心脚本说明

### 数据准备（预处理）
| 脚本 | 功能 | 输出 |
|------|------|------|
| `00_data_preparation.py` | 掩膜创建、格式检查 | masks/combined_mask.tif |

### TRc累积蒸腾计算
| 脚本 | 物候源 | 输出 |
|------|--------|------|
| `02_TRc_calculation.py` | GPP物候 | TRc_annual/, Climatology/ |

### TRc分解方法
| 脚本 | 方法 | 输出组分 |
|------|------|---------|
| `03c_decomposition_fixed_window.py` | 固定窗口分解 | TR_fixed_window, TR_window_change, TR_sos_change, TR_pos_change |

### 统计分析
| 脚本 | 对应方法 | 响应变量 |
|------|---------|---------|
| `04c_statistical_fixed_window.py` | 固定窗口 | TR_fixed_window, Fixed_Trate, TR_window_change |

### 高级分析
| 脚本 | 功能 | 语言 |
|------|------|------|
| `05c_SEM_analysis_robust_pooled_SOS.R` | Pooled SEM分析 | R |

---

# 2. 快速开始指南

## 📋 快速检查清单

### 准备阶段
- [ ] 已阅读 [使用说明.md](../使用说明.md) 项目说明
- [ ] 已安装Python依赖: `pip install -r requirements.txt`
- [ ] 确认 `_config.py` 配置正确（特别是 `USE_FOREST_MASK = False`）

### 数据验证（必须）
- [ ] 运行 `python _verify_data.py`
- [ ] 所有检查项通过
- [ ] 特别确认：
  - [ ] 物候数据: 37/37年份完整
  - [ ] TR数据: ERA5-Land格式抽样通过
  - [ ] GPP数据: 日尺度抽样通过
  - [ ] 土壤水分: SMrz深层抽样通过

### 掩膜准备（必须）
- [ ] 运行 `python 00_data_preparation.py`
- [ ] 看到提示: "掩膜策略: 所有陆地（≥30°N）"
- [ ] 生成掩膜文件: `masks/combined_mask.tif`

### 核心分析（耗时10-15小时）
- [ ] 运行 `python 00_master_pipeline.py`
- [ ] 或分步运行:
  - [ ] `python 02_TRc_calculation.py` (6-8小时)
  - [ ] `python 03c_decomposition_fixed_window.py` (1小时)
  - [ ] `python 04c_statistical_fixed_window.py` (2小时)
  - [ ] `Rscript 05c_SEM_analysis_robust_pooled_SOS.R` (可选)

### 结果检查
- [ ] 检查输出目录 `I:\F\Data4\Wang2025_Analysis\`:
  - [ ] `TRc_annual/` 包含37个年份文件
  - [ ] `Decomposition_FixedWindow/` 包含分解结果
  - [ ] `Statistical_Analysis_FixedWindow/` 包含统计分析

---

## 🚨 常见问题快速解决

| 问题 | 快速解决 |
|------|---------|
| "找不到物候数据" | 运行 `python _verify_data.py` 检查路径 |
| "找不到TR数据" | 确认文件格式为 `ERA5L_ET_transp_Daily_mm_YYYYMMDD.tif` |
| "TR_fixed_window全部为正值" | 检查05c代码Bug Fix 4，运行诊断工具 |
| 内存不足 | 编辑 `_config.py`: `BLOCK_SIZE=64`, `MAX_WORKERS=1` |

---

## ⏱️ 预估时间

| 步骤 | 预估时间 |
|------|---------|
| 数据验证 | 2-5分钟 |
| 准备掩膜 | 5-10分钟 |
| TRc计算 | 6-8小时 |
| 分解分析 | 1小时 |
| 统计分析 | 2-3小时 |
| **总计** | **10-15小时** |

---

# 3. 数据配置说明

## 📊 当前数据配置总结

根据您的数据结构，已配置好所有数据路径。

---

## 1. 数据路径配置

### 1.1 蒸腾数据（TR）- ERA5-Land

**路径**: `I:\F\Data4\Meteorological Data\ERA5_Land\ET_components\ET_transp\ET_transp_Daily\ET_transp_Daily_2`

**文件格式**: `ERA5L_ET_transp_Daily_mm_YYYYMMDD.tif`

**示例**:
- `ERA5L_ET_transp_Daily_mm_19820101.tif`
- `ERA5L_ET_transp_Daily_mm_20001231.tif`

---

### 1.2 土壤水分（SM）- GLEAM

#### ✅ 推荐：深层土壤水分（SMrz）

**路径**: `I:\F\Data4\Meteorological Data\GLEAM\SMrz\SMrz_Daily_1`

**文件格式**: `SMrz_YYYYMMDD.tif` ⭐ **日尺度**

**示例**:
- `SMrz_19820101.tif` (1982年1月1日)
- `SMrz_20001215.tif` (2000年12月15日)

**优势**: 日尺度数据比月尺度更精确，可以捕捉短期土壤水分变化

---

### 1.3 GPP数据

**路径**: `I:\F\Data4\GLASS_GPP\GLASS_GPP_daily_interpolated`

**文件格式**: `GPP_YYYYMMDD.tif`

**示例**:
- `GPP_19820101.tif`
- `GPP_20001231.tif`

---

### 1.4 物候数据（GPP物候 - 已计算）

**路径**: `I:\F\Data4\Phenology_Output_1\GPP_phenology_EPSG4326`

**文件格式**: （注意：物候代码输出为小写）

| 变量 | 文件名格式 | 说明 |
|------|-----------|------|
| **SOS** | `sos_gpp_{year}.tif` | 春季物候开始（DOY） |
| **POS** | `pos_doy_gpp_{year}.tif` | 生长季峰值（DOY） |
| **EOS** | `eos_gpp_{year}.tif` | 秋季物候结束（DOY） |

**示例**:
- `sos_gpp_2000.tif`
- `pos_doy_gpp_2000.tif`
- `eos_gpp_2000.tif`

**注意**:
- ✅ 文件名为小写（`sos_gpp`不是`SOS_gpp`）
- ✅ POS文件为`pos_doy_gpp`（不是`pos_gpp`）
- ✅ 物候数据已重投影到EPSG:4326标准坐标系

---

# 4. 修改记录

## [1.2.2] - 2025-01-10

### 🐛 Bug Fix 4: 修复05c clean_outliers函数错误过滤Fixed_Trate负值

**影响**: ⚠️ 严重数据丢失（47.80%）

**修改文件**: `05c_SEM_analysis_robust_pooled_SOS.R`

**问题描述**:
```r
# 错误代码（Line 430）
clean_outliers <- function(dt) {
  dt <- dt[Fixed_Trate > 0 & is.finite(Fixed_Trate)]  # ❌ 过滤所有负值
  ...
}
```

**影响**:
- 从807,599行 → 421,543行（丢失47.80%数据）
- 所有干旱年份数据（Fixed_Trate < 0）被错误移除

**修复**:
```r
# 正确代码（Line 430）
clean_outliers <- function(dt) {
  dt <- dt[is.finite(Fixed_Trate)]  # ✅ 仅过滤Inf/NaN，保留负值
  ...
}
```

**预期影响**:
- 数据保留率: 52.20% → ~100%
- 模型拟合质量改善（CFI >0.95, RMSEA <0.05）

---

## [1.2.1] - 2025-01-05

### 🐛 Bug Fix 3: 修复05c allow_negative参数错误

**影响**: ⚠️ TR_fixed_window数据丢失（从26409像元 → 8574像元）

**修改文件**: `05c_SEM_analysis_robust_pooled_SOS.R`

**问题**: 读取TR_fixed_window时错误设置 `allow_negative = FALSE`

**修复**: 改为 `allow_negative = TRUE`

---

## [1.2.0] - 2025-01-05

### ✨ 新增固定窗口方法（03c/04c/05c）

**新增文件**:
- `03c_decomposition_fixed_window.py` - 固定窗口分解
- `04c_statistical_fixed_window.py` - 固定窗口统计分析
- `05c_SEM_analysis_robust_pooled_SOS.R` - Pooled SEM分析

**核心方法**:
```
TR_fixed_window = TR_当年固定窗口 - TRc_av
Fixed_Trate = TR_fixed_window / Fixed_Window_Length
```

**优势**:
- 剥离窗口选择效应
- Fixed_Trate可以为负值（干旱年份）
- 直接回答"蒸腾速率是否真的变化"

---

## [1.1.0] - 2024-12-28

### ⚡ 性能优化: Numba JIT加速统计分析

**影响文件**: `04a/04b/04c_statistical_*.py`

**优化内容**:
- VIF计算使用Numba JIT编译（10-30x加速）
- 偏相关计算使用Numba JIT编译（5-20x加速）
- Section 3.3总体性能提升10-50倍

**性能提升**:
- 原版：Section 3.3可能需要数小时
- Numba版本：缩短至10-30分钟

---

## [1.0.0] - 2024-12-23

### 🎉 初始版本完成

**已完成**:
- ✅ 适配ERA5-Land TR数据格式
- ✅ 适配GPP物候（EPSG:4326投影）
- ✅ 配置SMrz深层土壤水分（日尺度）
- ✅ 添加`USE_FOREST_MASK`掩膜策略配置
- ✅ 创建数据验证脚本
- ✅ 整理文档结构

---

# 5. 项目修改总结

## ✅ 已完成的修改

所有代码已根据您的数据路径和格式进行更新，支持**先全局分析（≥30°N）后植被分层**的工作流程。

### 修改的核心文件

#### 5.1 _config.py - 核心配置文件
**修改内容**:
- ✅ 更新所有数据路径为实际路径
- ✅ TR数据: ERA5-Land格式 (`ERA5L_ET_transp_Daily_mm_YYYYMMDD.tif`)
- ✅ 土壤水分: 使用深层SMrz (推荐)
- ✅ GPP数据: 日尺度插值数据
- ✅ 物候数据: GPP物候（EPSG:4326投影）
- ✅ 添加 `USE_FOREST_MASK = False` 配置

**关键路径**:
```python
ROOT = Path(r"I:\F\Data4")
TR_DAILY_DIR = ROOT / "Meteorological Data" / "ERA5_Land" / "ET_components" / "ET_transp" / "ET_transp_Daily" / "ET_transp_Daily_2"
PHENO_DIR = ROOT / "Phenology_Output_1" / "GPP_phenology_EPSG4326"
GPP_DAILY_DIR = ROOT / "GLASS_GPP" / "GLASS_GPP_daily_interpolated"
SM_DAILY_DIR = GLEAM_ROOT / "SMrz" / "SMrz_Daily_1"  # 深层土壤水分
```

---

#### 5.2 核心脚本更新
- ✅ `00_data_preparation.py` - 掩膜准备
- ✅ `02_TRc_calculation.py` - TRc计算
- ✅ `03c_decomposition_fixed_window.py` - 固定窗口分解
- ✅ `04c_statistical_fixed_window.py` - 统计分析
- ✅ `05c_SEM_analysis_robust_pooled_SOS.R` - Pooled SEM

---

## 🐛 关键Bug修复

### Bug Fix 4 (2025-01-10)
**问题**: 05c错误过滤Fixed_Trate负值  
**影响**: 47.80%数据丢失  
**修复**: 允许负值（干旱年份）

### Bug Fix 3 (2025-01-05)
**问题**: TR_fixed_window负值过滤  
**影响**: 从26409像元 → 8574像元  
**修复**: 设置`allow_negative = TRUE`

---

# 6. 三种方法对比

## 固定窗口方法输出文件说明

### 6.1 核心概念

**固定窗口[SOSav, POSav]**:
- SOSav: 37年平均春季物候开始
- POSav: 37年平均生长季峰值
- 固定窗口长度 = POSav - SOSav + 1

### 6.2 输出文件对比

| 变量名 | 文件名 | 单位 | 含义 | 可否为负 |
|--------|--------|------|------|----------|
| **TRc_av** | `TRc_av.tif` | mm | 37年气候态固定窗口累积TR | ❌ 仅正值 |
| **Fixed_Window_Length** | `Fixed_Window_Length.tif` | days | 固定窗口长度 | ❌ 仅正值 |
| **TR_fixed_window** | `TR_fixed_window_YYYY.tif` | mm | 固定窗口强度差异 | ✅ **可为负** |
| **TR_window_change** | `TR_window_change_YYYY.tif` | mm | 窗口变化累积 | ✅ 可为负 |
| **TR_sos_change** | `TR_sos_change_YYYY.tif` | mm | SOS变化贡献 | ✅ 可为负 |
| **TR_pos_change** | `TR_pos_change_YYYY.tif` | mm | POS变化贡献 | ✅ 可为负 |
| **Fixed_Trate** | 临时计算 | mm/day | 固定窗口蒸腾速率 | ✅ **可为负** |

### 6.3 计算公式

```
TR_fixed_window = Σ[SOSav..POSav] B_y(t) - TRc_av

Fixed_Trate = TR_fixed_window / Fixed_Window_Length

TR_window_change = TRc_y - Σ[SOSav..POSav] B_y(t)
```

**重要**: 
- TR_fixed_window可以为负值（干旱年份，当年固定窗口内蒸腾强度低于气候态）
- Fixed_Trate可以为负值（从TR_fixed_window计算而来）

---

# 7. 结果诊断

## 统计结果差异分析

### 问题描述
05c SEM分析结果与预期存在差异。

### 常见问题

#### 7.1 TR_fixed_window全部为正值

**症状**: 诊断工具显示TR_fixed_window没有负值

**原因**: Bug Fix 3/4未正确应用

**解决方案**:
```bash
# 运行诊断工具检查
python diagnostics/check_decomposition.py

# 预期输出应该显示负值存在
# 负值像元: XXXXX (67.53%)
```

#### 7.2 数据保留率过低

**症状**: 05c输出显示大量数据被过滤

**原因**: Bug Fix 4未应用，`clean_outliers`函数过滤负值

**检查方法**:
```r
# 检查05c代码Line 430
# 应该是：dt <- dt[is.finite(Fixed_Trate)]
# 不应该是：dt <- dt[Fixed_Trate > 0 & is.finite(Fixed_Trate)]
```

---

## 📞 获取帮助

1. **数据验证**: 运行 `python _verify_data.py`
2. **诊断工具**: 运行 `python diagnostics/check_decomposition.py`
3. **查看主文档**: [../使用说明.md](../使用说明.md)
4. **诊断工具说明**: [../diagnostics/诊断工具说明.md](../diagnostics/诊断工具说明.md)

---

**文档更新**: 2025-01-10  
**项目版本**: v1.2.2
