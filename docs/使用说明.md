# Wang (2025) 复现代码使用说明

> 分析春季物候对森林蒸腾的直接和间接影响
> 基于 Wang et al. (2025) 论文方法
> **当前版本**: v1.2.2 (2025-01-10)

📚 **完整文档**: [docs/项目文档.md](docs/项目文档.md) | **诊断工具**: [diagnostics/诊断工具说明.md](diagnostics/诊断工具说明.md)

---

## 📍 快速导航

| 我想... | 查看文档 | 运行命令 |
|--------|---------|---------|
| 🚀 **立即开始** | 下方3步快速开始 | `python _verify_data.py` |
| ✅ **运行前检查** | [项目文档.md §2](docs/项目文档.md#2-快速开始指南) | - |
| 📖 **查看所有修改** | [项目文档.md §5](docs/项目文档.md#5-项目修改总结) | - |
| 🔧 **修改配置** | [项目文档.md §3](docs/项目文档.md#3-数据配置说明) | 编辑 `_config.py` |
| 📝 **查看版本历史** | [项目文档.md §4](docs/项目文档.md#4-修改记录) | - |
| 🐛 **诊断问题** | [diagnostics/诊断工具说明.md](diagnostics/诊断工具说明.md) | `python diagnostics/check_decomposition.py` |

---

## ⚡ 快速开始（3步）

```bash
# 1. 验证数据（2-5分钟）
python _verify_data.py

# 2. 准备掩膜（5-10分钟）
python 00_data_preparation.py

# 3. 运行分析（10-15小时）
python 00_master_pipeline.py
```

**详细步骤**: 请查看 [项目文档.md §2 快速开始指南](docs/项目文档.md#2-快速开始指南)

---

## 🎯 当前配置

### 数据路径（已配置好）
```python
根目录: I:\F\Data4
TR数据: ERA5-Land格式 (蒸腾日数据)
物候数据: GPP物候 (EPSG:4326投影)
土壤水分: SMrz深层 (推荐用于森林蒸腾研究)
```

### 分析范围
- **时间**: 1982-2018年（37年）
- **空间**: ≥30°N 所有陆地
- **策略**: 先全局分析，后植被分层（`USE_FOREST_MASK = False`）

### 数据格式
| 数据 | 格式 | 示例 |
|------|------|------|
| TR | `ERA5L_ET_transp_Daily_mm_YYYYMMDD.tif` | ERA5L_ET_transp_Daily_mm_19820101.tif |
| 物候 | `sos_gpp_{year}.tif`, `pos_doy_gpp_{year}.tif` | sos_gpp_1982.tif |
| 土壤水分 | `SMrz_YYYYMMDD.tif` ⭐ 日尺度 | SMrz_19801218.tif |

---

## 📂 核心文件说明

### 🔧 配置文件
- **[_config.py](_config.py)** - 所有路径和参数配置（已更新）

### 🐍 核心代码（按运行顺序）

| 模块 | 文件 | 功能 | 运行时间 | 必需？ |
|------|------|------|---------|-------|
| **00** | [00_data_preparation.py](00_data_preparation.py) | 创建掩膜、检查数据 | 5-10分钟 | ✅ 必需 |
| **02** | [02_TRc_calculation.py](02_TRc_calculation.py) | 计算累积蒸腾（GPP物候） | 6-8小时 | ✅ 必需 |
| **03c** | [03c_decomposition_fixed_window.py](03c_decomposition_fixed_window.py) | 固定窗口分解 | ~1小时 | ✅ 必需 |
| **04c** | [04c_statistical_fixed_window.py](04c_statistical_fixed_window.py) | 固定窗口统计分析 | 2-3小时 | ✅ 必需 |
| **05b** | [05b_SEM_analysis_dual_timescale_SOS.R](05b_SEM_analysis_dual_timescale_SOS.R) | 双时间尺度SEM（SOS→GPP→Fixed_Trate） | 1-2小时 | ⚠️ 需R环境 |
| **05c** | [05c_SEM_analysis_dual_timescale_robust_pooled_SOS.R](05c_SEM_analysis_dual_timescale_robust_pooled_SOS.R) | Pooled SEM分析 | ~1小时 | ⚠️ 需R环境 |
| **05d** | [05d_SEM_analysis_dual_timescale_lavaan_compare_SOS.R](05d_SEM_analysis_dual_timescale_lavaan_compare_SOS.R) | 像元级SEM对比（Ours/Other） | 1-2小时 | ⚠️ 需R环境 |

### 🛠️ 辅助工具
- **[_verify_data.py](_verify_data.py)** - 数据验证脚本（运行前必须用）
- **[diagnostics/check_decomposition.py](diagnostics/check_decomposition.py)** - 分解数据诊断工具
- **[00_master_pipeline.py](00_master_pipeline.py)** - 一键运行所有模块
- **[06_plotting.py](06_plotting.py)** - 绘图入口（04c + 05b/05c/05d）

### 📄 文档
- **[使用说明.md](使用说明.md)** - 本文档（项目主页）
- **[docs/项目文档.md](docs/项目文档.md)** - 完整项目文档（配置/修改记录/分析对比）
- **[diagnostics/诊断工具说明.md](diagnostics/诊断工具说明.md)** - 诊断工具使用说明

---

## 📊 输出结果

运行完成后，结果保存在 `I:\F\Data4\Wang2025_Analysis\`：

```
Wang2025_Analysis/
├── masks/                           # 掩膜文件
│   ├── lat_mask.tif
│   └── combined_mask.tif
├── TRc_annual/                      # 年度TRc（1982-2018）
│   └── TRc_*.tif
├── Climatology/                     # 气候态数据
│   ├── TR_daily_climatology.tif
│   ├── SOSav.tif
│   └── POSav.tif
├── Decomposition_FixedWindow/       # 固定窗口分解结果
│   ├── TRc_av.tif
│   ├── Fixed_Window_Length.tif
│   ├── TR_fixed_window_*.tif
│   ├── TR_window_change_*.tif
│   ├── TR_sos_change_*.tif
│   └── TR_pos_change_*.tif
├── Statistical_Analysis_FixedWindow/ # 统计分析结果
│   ├── Section_3_2_ΔSOS_Regression/
│   └── Section_3_3_Attribution/
├── SEM_Results_*/                    # SEM分析结果
└── Figures_All/                      # 统一绘图输出
```

---

## 🔧 修改配置

### 切换数据源

详细配置说明请查看 [项目文档.md §3 数据配置说明](docs/项目文档.md#3-数据配置说明)

**全局分析 ⇄ 仅森林**:
```python
# 编辑 _config.py
USE_FOREST_MASK = False  # 全局分析（当前）
# USE_FOREST_MASK = True  # 仅森林
```

---

## ⚠️ 重要注意事项

### 1. 物候数据格式
确认您的物候文件命名为：
- `sos_gpp_YYYY.tif` (小写)
- `pos_doy_gpp_YYYY.tif` (小写，DOY值)
- `eos_gpp_YYYY.tif` (小写)

### 2. 土壤水分数据优势 ⭐
- 您的土壤水分是**日尺度** (`SMrz_YYYYMMDD.tif`)
- 与TR和GPP的时间分辨率完全匹配
- **无需插值**，可直接用于逐日精确分析

### 3. Fixed_Trate可以为负值
- **负值是正常的**！表示干旱年份（当年固定窗口内蒸腾强度低于37年气候态）
- 用于诊断数据问题，请使用 `diagnostics/check_decomposition.py`

---

## 🐛 故障排除

| 问题 | 解决方案 |
|------|---------|
| "找不到物候数据" | 运行 `python _verify_data.py` 检查路径 |
| "找不到TR数据" | 确认文件格式为 `ERA5L_ET_transp_Daily_mm_YYYYMMDD.tif` |
| "TR_fixed_window全部为正值" | 检查05c代码Bug Fix 4，运行诊断工具 |
| 内存不足 | 编辑 `_config.py`: `BLOCK_SIZE=64`, `MAX_WORKERS=1` |

详细排错请查看 [项目文档.md §7 结果诊断](docs/项目文档.md#7-结果诊断) 或使用诊断工具

---

## 📚 环境要求

### Python依赖
```bash
pip install -r requirements.txt
```

主要包：numpy, scipy, pandas, rasterio, matplotlib, cartopy, tqdm

**可选性能优化**:
```bash
pip install numba  # 统计分析加速（10-50x）
```

### R依赖（仅SEM分析需要）
```R
install.packages(c("lavaan", "semPlot", "raster"))
```

---

## 🔄 最新更新

**最新版本**: v1.2.2 (2025-01-10)

**重要修复**:
- ✅ **Bug Fix 4**: 修复05c代码错误过滤Fixed_Trate负值（影响: 47.80%数据丢失 → 完整保留）
- ✅ **Bug Fix 3**: 修复05c代码TR_fixed_window负值过滤（影响: 8574像元 → 26409像元）
- ✅ 整合诊断工具模块（`diagnostics/`）
- ✅ 完善文档结构

详细修改记录: [项目文档.md §4 修改记录](docs/项目文档.md#4-修改记录)

---

## 📞 获取帮助

1. **运行前**: 查看 [项目文档.md §2 快速开始指南](docs/项目文档.md#2-快速开始指南)
2. **修改配置**: 查看 [项目文档.md §3 数据配置说明](docs/项目文档.md#3-数据配置说明)
3. **了解所有修改**: 查看 [项目文档.md §5 项目修改总结](docs/项目文档.md#5-项目修改总结)
4. **查看版本历史**: 查看 [项目文档.md §4 修改记录](docs/项目文档.md#4-修改记录)
5. **诊断问题**: 查看 [diagnostics/诊断工具说明.md](diagnostics/诊断工具说明.md)

---

## 📖 引用

如使用本代码，请引用原文：

```
Wang, X. et al. (2025). Direct and indirect effects of spring phenology
on forest transpiration. [期刊名称], [卷期页码].
```

---

**开始分析**: 请先运行 `python _verify_data.py` 验证数据 🚀

**文档更新**: 2025-01-10
