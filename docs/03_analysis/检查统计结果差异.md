# 统计结果差异诊断

**问题**：05_statistical_analysis.py的回归结果与论文差异巨大

---

## 🔍 您的结果 vs 论文结果

| 变量 | 您的结果 | 论文结果 | 差异倍数 | 符号 |
|------|---------|---------|---------|------|
| **TRc** | -1.515 | +0.76 | 2.0× | ✓ 一致（负斜率=提前时增加） |
| **TRpheno** | -0.432 | +1.80 | **4.2×** ⚠️ | ✓ 一致（负斜率=提前时增加） |
| **TRproduct** | -1.139 | -1.04 | 1.1× | ❓ 论文说"提前时**减少**" |

**符号解释**：
- 您的ΔSOS = SOS_year - SOSav（标准异常定义）
- 负斜率 = ΔSOS减少时变量增加 = SOS提前时变量增加 ✓
- 论文用"提前量"表述，符号方向一致

---

## 🎯 可能的原因

### 原因1: **TRc单位混淆** ⭐ 最可能

**问题**：
- TRc是**累积蒸腾量**（mm，整个SOS-POS期间的总量）
- 论文可能分析的是**日均TRc**（mm/day）

**证据**：
- 论文单位写的是"mm"而不是"mm total"
- TRpheno和TRproduct的单位也是相对于日均值

**影响**：
- 如果LSP平均长度为150天
- 您的TRc累积值 = 150 × 日均值
- 斜率会被放大150倍！

**修复方法**：
```python
# 在05_statistical_analysis.py中，读取TRc后添加归一化

# 读取LSP长度
sos_map = ...  # SOS栅格
pos_map = ...  # POS栅格
lsp_length = pos_map - sos_map + 1  # LSP天数

# 转换为日均值
TRc_daily = TRc / lsp_length  # mm/day

# 用日均值做回归
slope_map = linear_regression_maps(
    delta_sos_stack,
    TRc_daily_stack,  # ← 使用日均值
    min_frac=0.6
)
```

---

### 原因2: **掩膜范围不匹配**

**问题**：
- 论文明确说："1982—2018 年**森林**中"
- 您的combined_mask可能包含了所有植被类型

**检查方法**：
```python
# 查看掩膜文件中包含的土地覆盖类型
mask_file = "Wang2025_Analysis/masks/combined_mask.tif"

# 应该只包含森林像元（土地覆盖类型1-5？）
# 需要排除草地、灌木、农田等
```

**影响**：
- 非森林像元的TRc-SOS关系可能不同
- 会稀释/改变整体回归斜率

---

### 原因3: **TRpheno数值偏小4倍** ⚠️

**您的结果**: 0.432 mm vs **论文**: 1.80 mm（**差4.2倍**）

**可能原因**：
1. **分解方法问题**？
   - 注释说"Σ[SOS_y to SOSav]"
   - 但代码是"[SOS_y, SOSav-1]"（不包括SOSav）
   - 这是**正确的**（SOSav应该在TRc_av中）

2. **TR_daily_av数值问题**？
   - TR日气候态计算是否正确
   - 是否有很多NaN值导致累加偏小

3. **单位问题**？
   - 如果TRc需要除以LSP长度
   - TRpheno也需要相应调整

---

### 原因4: **统计方法不同**

**您的方法**（Line 766-767）：
```python
mean_slope = np.nanmean(slope_map[sig_mask])  # 所有像元简单平均
std_slope = np.nanstd(slope_map[sig_mask])
```

**论文可能的方法**：
1. **加权平均**（按像元面积或不确定性加权）
2. **分气候带统计后再加权**
3. **排除异常值后统计**

---

### 原因5: **TRproduct符号疑问** ❓

**您的结果**：-1.139（提前时增加）
**论文描述**："TRproduct 为 −1.04"（提前时**减少**）

**疑问**：
- 论文的"-1.04"可能是指"提前量 → TRproduct"的斜率（用您原来的dSOS定义）
- 或者论文的TRproduct定义与您不同

**需要验证**：
- 检查TRproduct = TRc - TRc_av - TRpheno的符号是否正确
- 论文是否用了不同的分解公式

---

## 🛠️ 建议的调试步骤

### 步骤1: 检查TRc是否需要归一化为日均值

**快速测试**：
```python
# 在一个测试年份检查TRc数值范围
import rasterio
import numpy as np

trc_file = "Wang2025_Analysis/TRc_annual/TRc_2000.tif"
sos_file = "Phenology_Output_1/GPP_phenology/sos_gpp_2000.tif"
pos_file = "Phenology_Output_1/GPP_phenology/pos_doy_gpp_2000.tif"

with rasterio.open(trc_file) as src:
    trc = src.read(1)

with rasterio.open(sos_file) as src:
    sos = src.read(1)

with rasterio.open(pos_file) as src:
    pos = src.read(1)

# 计算LSP长度和日均TRc
lsp = pos - sos + 1
trc_daily = trc / lsp

# 检查数值范围
print(f"TRc累积值: {np.nanmean(trc):.2f} mm (范围: {np.nanmin(trc):.2f} - {np.nanmax(trc):.2f})")
print(f"LSP平均长度: {np.nanmean(lsp):.1f} 天")
print(f"TRc日均值: {np.nanmean(trc_daily):.3f} mm/day (范围: {np.nanmin(trc_daily):.3f} - {np.nanmax(trc_daily):.3f})")
```

**预期结果**：
- TRc累积值：100-300 mm（整个生长季）
- LSP长度：120-180天
- TRc日均值：0.5-2.0 mm/day

---

### 步骤2: 检查掩膜是否只包含森林

```python
# 查看有效像元数量和空间分布
mask_file = "Wang2025_Analysis/masks/combined_mask.tif"
with rasterio.open(mask_file) as src:
    mask = src.read(1)
    print(f"有效像元数: {np.sum(mask > 0)}")
    print(f"掩膜值范围: {np.unique(mask)}")

# 如果有土地覆盖数据，检查与森林的重叠
```

---

### 步骤3: 检查TRpheno数值是否合理

```python
# 检查2000年的TRpheno
trpheno_file = "Wang2025_Analysis/Decomposition/TRpheno_2000.tif"
with rasterio.open(trpheno_file) as src:
    trpheno = src.read(1)

valid = (trpheno != -9999) & np.isfinite(trpheno)
print(f"TRpheno统计:")
print(f"  平均: {np.mean(trpheno[valid]):.2f} mm")
print(f"  范围: [{np.min(trpheno[valid]):.2f}, {np.max(trpheno[valid]):.2f}] mm")
print(f"  标准差: {np.std(trpheno[valid]):.2f} mm")
```

**预期范围**：
- 如果是累积值：-50 ~ +50 mm
- 如果是日均值：-0.5 ~ +0.5 mm/day

---

### 步骤4: 检查分解公式的正确性

```python
# 验证分解公式：TRc = TRc_av + TRpheno + TRproduct
trc_test = ...
trc_av = ...
trpheno_test = ...
trproduct_test = ...

residual = trc_test - trc_av - trpheno_test - trproduct_test
print(f"分解残差: {np.mean(np.abs(residual[valid])):.6f} mm")  # 应该≈0
```

---

## ✅ 最可能的修复方案

基于数值差异分析，**最可能的问题是TRc单位**：

### 修改05_statistical_analysis.py

在读取响应变量时添加LSP归一化：

```python
# Line 723-738，修改为：

# Step 3: 读取响应变量（TRc, TRpheno, TRproduct）
print("\n[Step 3] 读取响应变量...")
response_vars = ['TRc', 'TRpheno', 'TRproduct']
response_data = {}

# 先读取SOS和POS计算LSP长度
sos_stack_full = []  # 用于计算LSP
pos_stack_full = []

for year in tqdm(years, desc="读取物候（计算LSP）", leave=False):
    sos_data, _, sos_nodata = read_geotiff(PHENO_DIR / f"sos_gpp_{year}.tif")
    pos_data, _, pos_nodata = read_geotiff(PHENO_DIR / f"pos_doy_gpp_{year}.tif")

    sos_valid = np.where(_is_valid_value(sos_data, sos_nodata), sos_data, np.nan)
    pos_valid = np.where(_is_valid_value(pos_data, pos_nodata), pos_data, np.nan)

    sos_stack_full.append(sos_valid)
    pos_stack_full.append(pos_valid)

sos_stack_full = np.stack(sos_stack_full, axis=0)  # (n_years, H, W)
pos_stack_full = np.stack(pos_stack_full, axis=0)
lsp_stack = pos_stack_full - sos_stack_full + 1  # LSP长度（天）

# 读取响应变量并归一化
for resp_var in response_vars:
    data_stack = []
    for idx, year in enumerate(tqdm(years, desc=f"读取{resp_var}", leave=False)):
        if resp_var == 'TRc':
            data, _, nodata = read_geotiff(TRC_DIR / f"TRc_{year}.tif")
        else:
            data, _, nodata = read_geotiff(DECOMP_DIR / f"{resp_var}_{year}.tif")

        data_valid = np.where(_is_valid_value(data, nodata), data, np.nan)

        # ⭐ 关键修改：归一化为日均值
        if resp_var in ['TRc', 'TRpheno', 'TRproduct']:
            lsp = lsp_stack[idx]  # 当年LSP长度
            data_daily = np.where(
                np.isfinite(data_valid) & np.isfinite(lsp) & (lsp > 0),
                data_valid / lsp,  # 转换为日均值（mm/day）
                np.nan
            )
            data_stack.append(data_daily)
        else:
            data_stack.append(data_valid)

    response_data[resp_var] = np.stack(data_stack, axis=0)  # (n_years, H, W)

print(f"  ✓ 响应变量已归一化为日均值（mm/day）")
```

---

## 🎯 预期修复效果

如果LSP平均长度为150天，修改后预期结果：

| 变量 | 修改前 | 修改后（÷150） | 论文值 | 匹配度 |
|------|--------|---------------|--------|--------|
| TRc | -1.515 | **-0.010** | +0.76 | ❌ 仍不匹配 |
| TRpheno | -0.432 | **-0.003** | +1.80 | ❌ 仍不匹配 |
| TRproduct | -1.139 | **-0.008** | -1.04 | ❌ 仍不匹配 |

**如果修改后仍不匹配**：
- 说明单位不是主要问题
- 需要检查**掩膜范围**（森林vs所有植被）
- 或者论文使用了不同的**统计方法**（加权平均等）

---

## 📞 需要进一步信息

1. **您的TRc数值范围是多少**？（累积值应该在100-300 mm）
2. **您的掩膜包含多少像元**？（森林应该比所有植被少）
3. **论文中是否有其他关于统计方法的描述**？

请先运行步骤1的测试代码，看看TRc是否需要归一化！
