# 诊断工具模块 (Diagnostics)

用于验证Wang2025复现项目中各步骤输出数据的正确性。

---

## 📁 目录结构

```
diagnostics/
├── __init__.py                  # 模块初始化
├── check_decomposition.py       # 分解数据诊断工具（主要）
└── README.md                    # 本文档
```

---

## 🔧 可用工具

### **check_decomposition.py**

验证03c固定窗口分解的正确性，包含三个功能：

#### **1. TR_fixed_window值分布检查** (默认)
- **目的**: 验证TR_fixed_window确实存在负值（干旱年份）
- **输出**: 正负值比例、百分位数、统计信息
- **用法**:
  ```bash
  cd D:\claude-project\Wang2025_Replication
  python diagnostics/check_decomposition.py
  ```

#### **2. 物候有效像元统计**
- **目的**: 检查SOS/POS/TR的有效像元数是否合理
- **输出**: 气候态和年度数据的有效像元数、交集统计
- **用法**:
  ```bash
  python diagnostics/check_decomposition.py --mode pixels
  python diagnostics/check_decomposition.py --mode pixels --years 1990
  ```

#### **3. Enhancement Factor 详细诊断** (高级)
- **目的**: 手动重现03c的计算过程，验证逻辑正确性
- **输出**: 逐步计算TRc_av、enhancement_factor、TR_fixed_window
- **用法**:
  ```bash
  python diagnostics/check_decomposition.py --mode factor --pixel 500 500 --years 1990
  ```

---

## 📖 详细用法

### **命令行参数**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--mode` | 诊断模式: `values` / `pixels` / `factor` / `all` | `values` |
| `--years` | 检查的年份列表 | `1982 2000 2018` |
| `--pixel` | 像元坐标 (ROW COL)，仅factor模式需要 | 无 |

### **示例命令**

```bash
# 1. 快速检查TR值分布（最常用）
python diagnostics/check_decomposition.py

# 2. 检查特定年份的值分布
python diagnostics/check_decomposition.py --years 1985 1995 2005

# 3. 检查物候像元统计
python diagnostics/check_decomposition.py --mode pixels

# 4. 诊断特定像元的enhancement_factor计算
python diagnostics/check_decomposition.py --mode factor --pixel 500 500 --years 1990

# 5. 全面检查（包含所有功能）
python diagnostics/check_decomposition.py --mode all --years 1982 2000 2018

# 6. 全面检查 + 指定像元诊断
python diagnostics/check_decomposition.py --mode all --pixel 600 700
```

---

## 🎯 典型应用场景

### **场景1: 修复Bug后验证**

修复05c的`allow_negative = TRUE`后，验证TR_fixed_window恢复正常：

```bash
python diagnostics/check_decomposition.py
```

**预期输出**:
```
TR_fixed_window 值分布检查
======================================================================
检查文件: TR_fixed_window_1982.tif
======================================================================

🔍 正负值分布:
  负值像元: 17,835 (67.53%)  ✅
  零值像元: 0 (0.00%)
  正值像元: 8,574 (32.47%)

✅ 确认存在负值！
```

---

### **场景2: 检查数据完整性**

检查1982年各数据的有效像元数：

```bash
python diagnostics/check_decomposition.py --mode pixels --years 1982
```

**预期输出**:
```
物候和分解数据有效像元检查 (1982年)
======================================================================

📊 气候态物候:
  SOSav有效: 29,282 (11.30%)
  POSav有效: 29,282 (11.30%)
  两者交集: 29,282 (11.30%)

📊 1982年数据:
  SOS有效: 27,064 (10.44%)
  POS有效: 27,067 (10.44%)
  两者交集: 27,064 (10.44%)

  TR_fixed_window有效: 26,409 (10.19%)

  完整交集（SOS∩POS∩TR）: 26,409 (10.19%)
```

---

### **场景3: 调试计算错误**

当怀疑03c计算有误时，手动验证某个像元：

```bash
python diagnostics/check_decomposition.py --mode factor --pixel 500 500 --years 1990
```

**预期输出**:
```
Enhancement Factor 诊断 - 像元[500,500] 年份1990
================================================================================

📊 当年数据:
  TRc_y = 245.320 mm
  SOS_y = 125.0 (DOY)
  POS_y = 265.0 (DOY)

📈 气候态:
  SOSav = 130.0 (DOY)
  POSav = 260.0 (DOY)

🔍 增强因子:
  enhancement_factor = 245.320 / 250.100 = 0.980881
  ✅ < 1: 干旱年

🎯 TR_fixed_window:
  = 245.450 - 250.100 = -4.650 mm
  ✅ 负值：固定窗口强度低于气候态

📁 03c输出文件中的值:
  TR_fixed_window = -4.650 mm
  ✅ 手动计算与文件一致！(误差: 0.000000)
```

---

## ⚠️ 常见问题

### **Q1: 为什么TR_fixed_window有负值？**

**A**: 这是正常的！负值表示当年在固定窗口内的蒸腾强度低于37年气候态平均值，通常代表干旱年份。

- **负值 (enhancement_factor < 1)**: 干旱年
- **正值 (enhancement_factor > 1)**: 湿润年

### **Q2: 检查显示"未发现负值"怎么办？**

**A**: 这表明可能存在计算错误：

1. 检查05c是否错误设置了 `allow_negative = FALSE`
2. 运行 `--mode factor` 诊断具体像元的计算过程
3. 检查03c的enhancement_factor计算逻辑

### **Q3: 手动计算与文件不一致？**

**A**: 可能的原因：

1. 03c代码存在bug
2. 气候态文件损坏或不匹配
3. 像元坐标选择了NODATA区域

建议选择其他像元重新验证。

---

## 📝 版本历史

- **v1.0.0** (2025-01-05)
  - 整合 `check_tr_fixed_values.py`、`diagnose_enhancement_factor.py` 功能
  - 添加物候像元统计功能
  - 统一命名规范

---

## 🔗 相关文件

- **主配置**: `_config.py`
- **数据验证**: `_verify_data.py` (路径/文件存在性检查)
- **分解代码**: `03c_decomposition_fixed_window.py`
- **统计代码**: `04c_statistical_fixed_window.py`
- **SEM分析**: `05c_SEM_analysis_robust_pooled_SOS.R`

---

**作者**: Wang2025 Replication Project
**更新**: 2025-01-05
